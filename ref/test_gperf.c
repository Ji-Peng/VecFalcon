#include <gperftools/profiler.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "fndsa.h"
#include "sign_inner.h"

static void gperf_sign_1024()
{
    uint8_t seed[8];
    for (int i = 0; i < 8; i++) {
        seed[i] = (uint8_t)(0xffffffff >> (i << 3));
    }
    // uint8_t sk[FNDSA_SIGN_KEY_SIZE(10)];
    // uint8_t vk[FNDSA_VRFY_KEY_SIZE(10)];
    // fndsa_keygen_seeded(10, seed, sizeof seed, sk, vk);
    // for (int i = 0; i < FNDSA_SIGN_KEY_SIZE(10); i++) {
    //     printf("%u,", sk[i]);
    //     fflush(stdout);
    // }
    uint8_t sk[] = {
        90,  0,   12,  82,  255, 128, 225, 62,  66,  12,  2,   31,  191,
        208, 147, 225, 47,  254, 66,  16,  161, 232, 4,   49,  124, 127,
        224, 12,  31,  4,   70,  216, 182, 15,  244, 99,  247, 67,  225,
        240, 92,  247, 187, 241, 23,  195, 17,  63,  207, 251, 252, 31,
        128, 17,  132, 218, 8,   58,  16,  139, 224, 255, 126, 16,  8,
        33,  0,   5,   255, 4,   94,  8,   5,   224, 4,   98,  192, 67,
        192, 255, 192, 248, 128, 15,  136, 193, 33,  124, 14,  99,  252,
        23,  133, 225, 248, 32,  9,   124, 2,   115, 163, 233, 62,  49,
        0,   96,  7,   64,  32,  116, 67,  14,  62,  0,   123, 194, 0,
        197, 176, 131, 163, 16,  192, 96,  139, 192, 40,  133, 177, 0,
        99,  31,  250, 15,  128, 223, 239, 191, 242, 4,   30,  248, 65,
        222, 143, 97,  239, 66,  15,  132, 128, 0,   189, 159, 147, 224,
        7,   58,  33,  127, 191, 24,  7,   240, 11,  126, 32,  55,  238,
        239, 190, 7,   128, 0,   12,  31,  225, 132, 47,  0,   64,  8,
        202, 49,  127, 251, 239, 133, 255, 131, 226, 248, 197, 255, 128,
        32,  240, 196, 1,   131, 103, 31,  122, 18,  127, 255, 239, 4,
        61,  240, 30,  247, 51,  239, 136, 32,  63,  198, 14,  0,   3,
        57,  6,   34,  123, 224, 15,  129, 194, 240, 35,  32,  1,   224,
        255, 222, 254, 252, 114, 135, 122, 9,   0,   62,  7,   159, 15,
        65,  239, 251, 59,  247, 193, 225, 4,   1,   8,   137, 190, 147,
        252, 16,  73,  225, 119, 129, 23,  68,  31,  16,  27,  40,  250,
        77,  236, 1,   208, 121, 241, 155, 224, 32,  195, 255, 120, 64,
        7,   69,  255, 156, 1,   255, 129, 210, 124, 64,  8,   253, 226,
        135, 93,  25,  191, 240, 136, 194, 7,   253, 241, 120, 96,  22,
        75,  241, 127, 195, 16,  189, 223, 248, 94,  239, 195, 222, 8,
        157, 24,  64,  30,  136, 31,  248, 69,  240, 128, 125, 239, 69,
        242, 16,  28,  247, 125, 208, 147, 253, 247, 120, 15,  144, 63,
        233, 61,  226, 136, 31,  239, 3,   192, 8,   65,  39,  61,  225,
        255, 96,  17,  69,  175, 140, 93,  247, 246, 47,  136, 94,  255,
        68,  17,  0,   131, 7,   134, 0,   139, 222, 240, 130, 62,  131,
        221, 255, 198, 47,  248, 60,  32,  248, 79,  244, 61,  7,   131,
        176, 240, 97,  31,  255, 209, 11,  252, 254, 246, 63,  119, 227,
        232, 18,  1,   119, 168, 16,  248, 48,  131, 133, 41,  63,  224,
        139, 189, 223, 128, 46,  247, 193, 7,   131, 222, 143, 222, 255,
        252, 62,  131, 196, 31,  255, 254, 128, 69,  72,  8,   1,   15,
        221, 232, 129, 253, 235, 226, 23,  193, 226, 107, 158, 247, 5,
        208, 244, 98,  240, 119, 208, 4,   94,  239, 252, 14,  236, 127,
        224, 201, 239, 132, 69,  1,   64,  15,  136, 5,   31,  131, 241,
        15,  222, 224, 4,   48,  255, 124, 39,  140, 14,  247, 223, 6,
        199, 241, 147, 254, 24,  128, 49,  151, 98,  24,  9,   224, 115,
        227, 238, 251, 225, 248, 65,  46,  0,   0,   0,   127, 240, 64,
        30,  131, 193, 248, 187, 209, 123, 92,  8,   55,  254, 123, 222,
        255, 251, 236, 116, 67,  14,  252, 46,  239, 221, 8,   128, 2,
        139, 225, 248, 198, 48,  144, 66,  31,  64,  62,  132, 189, 40,
        140, 15,  251, 135, 9,   3,   207, 8,   66,  247, 252, 47,  19,
        126, 241, 188, 14,  147, 255, 24,  132, 30,  144, 70,  47,  255,
        255, 135, 252, 255, 63,  205, 248, 222, 232, 3,   237, 136, 34,
        247, 6,   2,   120, 36,  15,  192, 47,  151, 161, 16,  124, 64,
        127, 64,  223, 198, 33,  4,   128, 248, 255, 223, 236, 104, 239,
        68,  65,  7,   223, 16,  2,   16,  248, 69,  80,  133, 222, 136,
        127, 232, 72,  63,  124, 97,  200, 67,  222, 152, 100, 248, 128,
        31,  247, 225, 23,  67,  224, 4,   36,  16,  189, 193, 147, 66,
        253, 191, 159, 124, 35,  0,   2,   0,   144, 63,  255, 68,  47,
        131, 190, 231, 255, 240, 136, 68,  231, 180, 48,  255, 184, 8,
        184, 32,  140, 62,  8,   72,  82,  115, 225, 232, 61,  227, 119,
        224, 7,   130, 0,   107, 196, 248, 60,  127, 12,  65,  216, 8,
        64,  255, 231, 225, 5,   160, 8,   162, 232, 0,   66,  116, 2,
        238, 255, 224, 11,  198, 255, 197, 227, 8,   97,  15,  124, 32,
        8,   3,   247, 196, 94,  240, 2,   247, 252, 32,  139, 254, 15,
        191, 239, 3,   127, 247, 128, 48,  104, 36,  200, 12,  80,  143,
        159, 47,  137, 254, 143, 188, 47,  130, 1,   132, 157, 9,   8,
        17,  11,  224, 7,   130, 1,   7,   165, 248, 0,   93,  247, 162,
        7,   126, 30,  131, 254, 224, 1,   240, 120, 65,  249, 60,  46,
        248, 37,  248, 132, 51,  128, 223, 247, 199, 176, 124, 65,  247,
        186, 31,  127, 226, 240, 10,  126, 0,   3,   232, 10,  30,  248,
        65,  240, 58,  62,  12,  158, 240, 1,   207, 24,  101, 200, 65,
        239, 116, 69,  248, 67,  238, 236, 131, 0,   2,   15,  248, 62,
        232, 54,  50,  140, 126, 0,   73,  208, 252, 65,  40,  123, 240,
        0,   32,  201, 74,  49,  147, 187, 7,   252, 32,  119, 128, 240,
        65,  254, 250, 194, 0,   54,  63,  144, 68,  63,  192, 33,  0,
        121, 8,   1,   193, 112, 94,  8,   75,  239, 8,   98,  248, 59,
        226, 0,   93,  7,   185, 239, 3,   189, 248, 11,  237, 132, 62,
        249, 63,  223, 128, 1,   239, 194, 48,  232, 91,  209, 0,   64,
        4,   29,  247, 65,  226, 123, 226, 7,   124, 64,  140, 0,   255,
        195, 206, 123, 253, 16,  140, 17,  7,   222, 31,  0,   16,  248,
        193, 17,  124, 17,  139, 221, 208, 195, 207, 248, 226, 241, 11,
        241, 0,   67,  23,  130, 46,  124, 98,  24,  63,  224, 4,   31,
        40,  2,   48,  148, 160, 0,   129, 241, 136, 28,  7,   187, 240,
        15,  220, 47,  131, 241, 7,   189, 254, 195, 224, 127, 191, 240,
        253, 127, 131, 224, 15,  142, 1,   116, 127, 32,  197, 191, 120,
        31,  215, 130, 50,  128, 98,  8,   59,  207, 252, 65,  31,  204,
        17,  120, 127, 63,  197, 255, 247, 255, 8,   72,  16,  4,   66,
        232, 191, 255, 132, 33,  239, 126, 3,   125, 95,  16,  120, 0,
        119, 226, 15,  67,  177, 127, 125, 14,  2,   32,  135, 133, 15,
        2,   29,  235, 159, 241, 12,  64,  124, 98,  17,  66,  79,  12,
        66,  72,  0,   33,  20,  1,   255, 184, 33,  255, 227, 7,   64,
        35,  16,  32,  232, 130, 62,  124, 123, 8,   64,  0,   243, 164,
        240, 60,  48,  0,   128, 0,   67,  226, 7,   98,  240, 190, 14,
        112, 36,  255, 127, 254, 12,  35,  15,  60,  19,  132, 34,  247,
        184, 1,   132, 62,  7,   120, 49,  244, 130, 248, 184, 48,  128,
        35,  249, 1,   207, 124, 31,  239, 249, 241, 19,  194, 225, 198,
        17,  128, 3,   16,  4,   48,  247, 162, 239, 68,  30,  120, 68,
        239, 129, 221, 252, 65,  248, 134, 0,   143, 195, 255, 136, 47,
        132, 96,  7,   64,  31,  24,  32,  255, 188, 63,  144, 95,  248,
        132, 66,  135, 225, 8,   52,  96,  152, 60,  248, 126, 65,  16,
        2,   23,  132, 46,  120, 2,   0,   249, 240, 124, 93,  8,   0,
        61,  131, 124, 8,   4,   15,  140, 63,  247, 117, 193, 132, 29,
        23,  2,   16,  0,   63,  255, 197, 222, 144, 60,  24,  56,  65,
        244, 66,  247, 188, 94,  131, 225, 254, 22,  81,  214, 243, 47,
        35,  6,   26,  252, 14,  255, 33,  249, 248, 214, 238, 8,   245,
        253, 4,   5,   250, 255, 240, 219, 13,  246, 225, 254, 251, 227,
        22,  251, 20,  249, 35,  245, 246, 249, 232, 226, 9,   5,   4,
        214, 236, 249, 249, 239, 252, 236, 246, 216, 250, 10,  241, 37,
        224, 230, 0,   43,  29,  247, 28,  30,  27,  14,  28,  226, 253,
        22,  251, 241, 237, 90,  10,  250, 5,   253, 27,  17,  25,  10,
        16,  213, 47,  226, 8,   236, 238, 240, 236, 219, 237, 3,   32,
        240, 23,  4,   255, 6,   230, 15,  48,  20,  236, 240, 220, 225,
        45,  21,  4,   247, 3,   35,  11,  250, 32,  19,  11,  42,  34,
        3,   15,  250, 236, 37,  215, 6,   2,   2,   4,   236, 240, 213,
        25,  13,  8,   222, 6,   239, 240, 250, 26,  207, 196, 6,   244,
        202, 234, 21,  23,  231, 15,  224, 226, 225, 243, 243, 242, 251,
        251, 254, 25,  15,  19,  20,  3,   237, 193, 2,   242, 237, 22,
        23,  14,  58,  3,   33,  21,  38,  251, 18,  216, 252, 241, 239,
        9,   245, 249, 251, 23,  62,  26,  19,  22,  5,   23,  249, 244,
        10,  253, 255, 17,  50,  247, 255, 4,   11,  242, 248, 230, 247,
        42,  21,  240, 6,   247, 248, 8,   17,  7,   2,   252, 233, 250,
        55,  8,   222, 20,  4,   19,  245, 253, 37,  251, 11,  2,   243,
        232, 0,   29,  245, 16,  202, 244, 3,   241, 255, 10,  8,   37,
        12,  9,   236, 21,  243, 10,  253, 245, 250, 244, 223, 11,  238,
        236, 246, 9,   23,  223, 7,   237, 232, 26,  7,   15,  250, 229,
        198, 17,  247, 7,   249, 22,  230, 14,  12,  226, 40,  228, 18,
        251, 13,  45,  6,   51,  245, 8,   219, 27,  253, 11,  26,  3,
        4,   4,   3,   38,  255, 251, 252, 245, 25,  3,   4,   244, 241,
        29,  241, 0,   26,  25,  9,   232, 202, 6,   23,  6,   33,  12,
        218, 3,   246, 32,  6,   239, 0,   242, 10,  233, 240, 12,  14,
        247, 199, 231, 250, 225, 26,  11,  2,   241, 242, 210, 6,   248,
        17,  33,  2,   2,   11,  28,  4,   244, 235, 247, 240, 251, 225,
        239, 3,   46,  235, 232, 234, 33,  27,  255, 223, 228, 6,   214,
        11,  19,  244, 249, 247, 233, 2,   244, 181, 225, 6,   248, 20,
        17,  247, 42,  17,  16,  243, 22,  14,  19,  22,  247, 248, 226,
        254, 225, 30,  243, 38,  13,  241, 49,  14,  249, 243, 216, 245,
        22,  255, 21,  252, 2,   208, 246, 216, 25,  14,  230, 250, 208,
        21,  242, 36,  28,  243, 10,  254, 238, 249, 6,   15,  212, 241,
        57,  63,  193, 28,  9,   9,   9,   242, 5,   24,  2,   225, 246,
        10,  29,  218, 248, 248, 31,  1,   21,  241, 254, 36,  32,  37,
        223, 11,  18,  237, 218, 234, 215, 229, 0,   242, 4,   237, 247,
        15,  47,  244, 7,   255, 15,  39,  224, 233, 28,  3,   217, 1,
        201, 20,  242, 18,  249, 248, 9,   242, 34,  2,   13,  244, 12,
        240, 18,  14,  250, 18,  224, 209, 241, 32,  36,  41,  233, 25,
        37,  4,   29,  19,  59,  252, 26,  249, 8,   7,   55,  254, 223,
        246, 17,  247, 249, 227, 201, 233, 19,  31,  22,  244, 238, 247,
        244, 203, 241, 22,  246, 239, 252, 22,  239, 9,   253, 250, 252,
        247, 17,  15,  47,  16,  234, 16,  6,   222, 228, 0,   26,  229,
        235, 249, 14,  229, 18,  13,  10,  250, 0,   246, 24,  8,   0,
        3,   26,  59,  248, 25,  11,  3,   241, 211, 236, 252, 45,  249,
        242, 227, 10,  232, 2,   8,   206, 239, 255, 9,   210, 0,   235,
        241, 209, 27,  216, 20,  2,   10,  252, 246, 245, 244, 225, 9,
        22,  0,   10,  0,   25,  248, 252, 11,  47,  215, 18,  43,  239,
        15,  241, 225, 253, 26,  31,  251, 221, 252, 12,  235, 228, 242,
        254, 236, 44,  255, 245, 19,  30,  206, 5,   36,  11,  254, 7,
        26,  253, 238, 253, 3,   242, 221, 246, 11,  20,  11,  187, 0,
        214, 239, 25,  47,  229, 188, 30,  26,  254, 251, 9,   249, 243,
        17,  41,  24,  19,  13,  227, 5,   7,   7,   52,  236, 4,   235,
        16,  30,  253, 241, 24,  243, 233, 26,  21,  31,  233, 190, 0,
        9,   1,   241, 29,  208, 213, 11,  2,   241, 2,   228, 247, 239,
        232, 238, 220, 25,  12,  9,   238, 24,  7,   36,  241, 248, 249,
        24,  30,  203, 14,  242, 32,  253, 46,  236, 28,  33,  250, 197,
        2,   38,  243, 217, 12,  44,  249, 236, 26,  0,   222, 238, 235,
        209, 0,   250, 26,  5,   240, 28,  228, 20,  244, 63,  245, 236,
        245, 13,  251, 33,  226, 212, 3,   243, 48,  7,   206, 247, 253,
        235, 234, 20,  210, 20,  0,   3,   2,   222, 0,   27,  7,   239,
        227, 242, 14,  55,  14,  251, 12,  25,  253, 17,  254, 12,  33,
        253, 231, 18,  243, 46,  46,  11,  14,  13,  1,   218, 229, 245,
        240, 219, 23,  27,  243, 234, 253, 243, 229, 11,  239, 26,  200,
        220, 217, 244, 250, 23,  233, 24,  46,  2,   241, 198, 1,   244,
        19,  44,  12,  213, 237, 45,  14,  253, 232, 232, 230, 48,  253,
        23,  10,  12,  0,   253, 14,  24,  37,  20,  244, 15,  41,  233,
        188, 23,  249, 40,  242, 251, 4,   5,   193, 229, 224, 37,  37,
        241, 248, 212, 252, 250, 240, 230, 244, 207, 247, 14,  223, 19,
        229, 6,   243, 2,   23,  238, 245, 28,  5,   0,   223, 0,   20,
        8,   228, 243, 22,  21,  57,  1,   34,  42,  249, 248, 238, 25,
        19,  253, 9,   254, 244, 0,   22,  11,  231, 20,  3,   203, 241,
        247, 12,  233, 248, 22,  35,  26,  19,  11,  248, 236, 217, 232,
        245, 250, 12,  231, 251, 13,  12,  38,  55,  233, 25,  245, 240,
        226, 8,   0,   250, 39,  18,  23,  239, 20,  242, 6,   0,   17,
        253, 234, 10,  4,   1,   243, 246, 1,   71,  232, 21,  243, 247,
        7,   238, 27,  253, 11,  13,  0,   232, 5,   11,  15,  220, 15,
        229, 228, 11,  216,
    };
    uint8_t sig[FNDSA_SIGNATURE_SIZE(10)];
    for (int i = 0; i < 10000; i++) {
        fndsa_sign_seeded(sk, FNDSA_SIGN_KEY_SIZE(10), NULL, 0,
                          FNDSA_HASH_ID_RAW, "test", 4, seed, sizeof seed,
                          sig, FNDSA_SIGNATURE_SIZE(10));
    }
}

#include "KAT.c"

static void gperf_sign_core_1024()
{
    uint8_t sig[FNDSA_SIGNATURE_SIZE(10)];
    uint8_t seed[8];
    uint8_t tmp[(1024) * 78 + 31];
    size_t j;

    for (int i = 0; i < 8; i++) {
        seed[i] = (uint8_t)(0xffffffff >> (i << 3));
    }

    for (int i = 0; i < 10000; i++) {
        j = sign_core(10, KAT1024_f, KAT1024_g, KAT1024_F, KAT1024_G,
                      KAT1024_hashed_vk, NULL, 0, FNDSA_HASH_ID_RAW,
                      KAT1024_hv, 4, seed, sizeof(seed), sig, tmp);
    }
    if (j != FNDSA_SIGNATURE_SIZE(10)) {
        fprintf(stderr, "wrong output size: %zu\n", j);
        exit(EXIT_FAILURE);
    }
    // if (memcmp(KAT1024_sig, sig, sizeof KAT1024_sig) != 0) {
    //     fprintf(stderr, "wrong signature\n");
    //     exit(EXIT_FAILURE);
    // }
}

/* Defined in test_sampler.c */
void gperf_sampler(void);

int main(int argc, char *argv[])
{
    if (argc != 2) {
        printf("Usage: %s <number>\n", argv[0]);
        printf("Example: %s 1: gperf the signature generation function\n",
               argv[0]);
        printf("Example: %s 2: gperf the sampler_next subroutine\n",
               argv[0]);
        return 1;
    }

    int number = atoi(argv[1]);
    if (number == 1) {
        const char *basename = "gperf_sign_1024";
        char profname[64];
        char textname[64];

        snprintf(profname, sizeof(profname), "%s.prof", basename);
        snprintf(textname, sizeof(textname), "%s.txt", basename);
        printf("gperf the signature generation function. Filename: %s\n",
               profname);
        ProfilerStart(profname);
        gperf_sign_1024();
        ProfilerStop();
        printf("Run the command: pprof --text ./out/test_gperf %s > %s",
               profname, textname);
    } else if (number == 2) {
        const char *basename = "gperf_sampler_next";
        char profname[64];
        char textname[64];

        snprintf(profname, sizeof(profname), "%s.prof", basename);
        snprintf(textname, sizeof(textname), "%s.txt", basename);
        printf("gperf the sampler_next subroutine. Filename: %s\n",
               profname);
        ProfilerStart(profname);
        gperf_sampler();
        ProfilerStop();
        printf("Run the command: pprof --text ./out/test_gperf %s > %s",
               profname, textname);
    } else if (number == 3) {
        const char *basename = "gperf_sign_core_1024";
        char profname[64];
        char textname[64];

        snprintf(profname, sizeof(profname), "%s.prof", basename);
        snprintf(textname, sizeof(textname), "%s.txt", basename);
        printf("gperf the sign_core subroutine. Filename: %s\n", profname);
        ProfilerStart(profname);
        gperf_sign_core_1024();
        ProfilerStop();
        printf("Run the command: pprof --text ./out/test_gperf %s > %s",
               profname, textname);
    } else {
        printf("The second argument is neither 1 nor 2.\n");
    }

    return 0;
}